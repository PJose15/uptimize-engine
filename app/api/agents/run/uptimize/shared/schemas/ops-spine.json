{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "UptimizeAI_OpsSpine_v2",
  "type": "object",
  "description": "Shared canonical schema (Ops Spine) used by Agents 1–5. All agents read/write these entities and reference each other by IDs.",
  "required": ["schema_version", "workspace", "entities"],
  "properties": {
    "schema_version": { "type": "string", "enum": ["2.0"] },
    "workspace": {
      "type": "object",
      "required": ["workspace_id", "timezone", "owner_name"],
      "properties": {
        "workspace_id": { "type": "string" },
        "timezone": { "type": "string" },
        "owner_name": { "type": "string" }
      }
    },
    "entities": {
      "type": "object",
      "required": [
        "leads",
        "accounts",
        "opportunities",
        "projects",
        "workflows",
        "deliverables",
        "kpis",
        "tickets",
        "change_requests",
        "proof_assets",
        "audit_events"
      ],
      "properties": {
        "leads": { "type": "array", "items": { "$ref": "#/$defs/Lead" } },
        "accounts": { "type": "array", "items": { "$ref": "#/$defs/Account" } },
        "opportunities": { "type": "array", "items": { "$ref": "#/$defs/Opportunity" } },
        "projects": { "type": "array", "items": { "$ref": "#/$defs/Project" } },
        "workflows": { "type": "array", "items": { "$ref": "#/$defs/Workflow" } },
        "deliverables": { "type": "array", "items": { "$ref": "#/$defs/Deliverable" } },
        "kpis": { "type": "array", "items": { "$ref": "#/$defs/KPI" } },
        "tickets": { "type": "array", "items": { "$ref": "#/$defs/Ticket" } },
        "change_requests": { "type": "array", "items": { "$ref": "#/$defs/ChangeRequest" } },
        "proof_assets": { "type": "array", "items": { "$ref": "#/$defs/ProofAsset" } },
        "audit_events": { "type": "array", "items": { "$ref": "#/$defs/AuditEvent" } }
      }
    }
  },

  "$defs": {
    "ID": { "type": "string", "minLength": 6, "maxLength": 64 },

    "Timestamp": {
      "type": "string",
      "description": "ISO-8601 timestamp",
      "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}T"
    },

    "Owner": {
      "type": "object",
      "required": ["owner_type", "owner_id"],
      "properties": {
        "owner_type": {
          "type": "string",
          "enum": ["agent1", "agent2", "agent3", "agent4", "agent5", "agent6", "agent7", "agent8", "agent9", "agent10", "you", "client", "unassigned"]
        },
        "owner_id": { "$ref": "#/$defs/ID" }
      }
    },

    "TagSet": {
      "type": "object",
      "required": ["pain", "objections", "outcomes", "exceptions", "shadow_ops"],
      "properties": {
        "pain": { "type": "array", "items": { "type": "string" } },
        "objections": { "type": "array", "items": { "type": "string" } },
        "outcomes": { "type": "array", "items": { "type": "string" } },
        "exceptions": { "type": "array", "items": { "type": "string" } },
        "shadow_ops": { "type": "array", "items": { "type": "string" } }
      }
    },

    "Link": {
      "type": "object",
      "required": ["label", "url"],
      "properties": {
        "label": { "type": "string" },
        "url": { "type": "string" }
      }
    },

    "AuditTrail": {
      "type": "object",
      "required": ["audit_trail_completeness", "last_audit_event_at"],
      "properties": {
        "audit_trail_completeness": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "0.0–1.0 ratio of expected audit events captured"
        },
        "last_audit_event_at": { "$ref": "#/$defs/Timestamp" }
      }
    },

    "SalesStage": {
      "type": "string",
      "enum": [
        "NEW",
        "CONTACTED",
        "REPLIED",
        "QUALIFYING",
        "QUALIFIED",
        "BOOKED",
        "PROPOSAL_SENT",
        "CLOSED_WON",
        "CLOSED_LOST",
        "NURTURE"
      ]
    },

    "DeliveryStage": {
      "type": "string",
      "enum": ["KICKOFF", "BUILDING", "QA", "HANDOFF", "LIVE", "OPTIMIZING", "PAUSED", "COMPLETE"]
    },

    "SuccessStage": {
      "type": "string",
      "enum": ["ONBOARDING", "ADOPTING", "STABLE", "EXPANDING", "RENEWED", "CHURN_RISK", "CHURNED"]
    },

    "Severity": { "type": "string", "enum": ["P1", "P2", "P3"] },

    "Status": { "type": "string", "enum": ["open", "in_progress", "blocked", "resolved", "closed"] },

    "Lead": {
      "type": "object",
      "required": [
        "lead_id",
        "created_at",
        "updated_at",
        "owner",
        "sales_stage",
        "name",
        "company",
        "role",
        "segment",
        "fit_score_0_100",
        "shadow_ops_density_0_10",
        "tags",
        "notes"
      ],
      "properties": {
        "lead_id": { "$ref": "#/$defs/ID" },
        "created_at": { "$ref": "#/$defs/Timestamp" },
        "updated_at": { "$ref": "#/$defs/Timestamp" },
        "owner": { "$ref": "#/$defs/Owner" },
        "sales_stage": { "$ref": "#/$defs/SalesStage" },

        "name": { "type": "string" },
        "company": { "type": "string" },
        "role": { "type": "string" },
        "segment": { "type": "string" },

        "contact": {
          "type": "object",
          "properties": {
            "email": { "type": "string" },
            "phone": { "type": "string" },
            "linkedin": { "type": "string" },
            "website": { "type": "string" }
          }
        },

        "fit_score_0_100": { "type": "integer", "minimum": 0, "maximum": 100 },
        "shadow_ops_density_0_10": { "type": "integer", "minimum": 0, "maximum": 10 },

        "shadow_ops_signals": { "type": "array", "items": { "type": "string" } },
        "exception_hypotheses_top3": { "type": "array", "items": { "type": "string" }, "maxItems": 3 },

        "account_id": { "$ref": "#/$defs/ID", "description": "Optional link if lead already mapped to an account" },
        "opportunity_id": { "$ref": "#/$defs/ID", "description": "Optional link if lead already in an opportunity" },

        "sources": { "type": "array", "items": { "type": "string" } },
        "links": { "type": "array", "items": { "$ref": "#/$defs/Link" } },

        "tags": { "$ref": "#/$defs/TagSet" },
        "notes": { "type": "string" }
      }
    },

    "Account": {
      "type": "object",
      "required": [
        "account_id",
        "created_at",
        "updated_at",
        "owner",
        "account_name",
        "industry",
        "size_hint",
        "tools_hint",
        "shadow_ops_profile",
        "tags",
        "notes"
      ],
      "properties": {
        "account_id": { "$ref": "#/$defs/ID" },
        "created_at": { "$ref": "#/$defs/Timestamp" },
        "updated_at": { "$ref": "#/$defs/Timestamp" },
        "owner": { "$ref": "#/$defs/Owner" },

        "account_name": { "type": "string" },
        "industry": { "type": "string" },
        "size_hint": { "type": "string", "description": "e.g., solo, 2-10, 11-50, 51-200, enterprise" },
        "tools_hint": { "type": "array", "items": { "type": "string" } },

        "shadow_ops_profile": {
          "type": "object",
          "required": ["off_system_channels", "top_shadow_tasks", "top_exceptions"],
          "properties": {
            "off_system_channels": { "type": "array", "items": { "type": "string" } },
            "top_shadow_tasks": { "type": "array", "items": { "type": "string" } },
            "top_exceptions": { "type": "array", "items": { "type": "string" } }
          }
        },

        "primary_contact_lead_id": { "$ref": "#/$defs/ID" },
        "links": { "type": "array", "items": { "$ref": "#/$defs/Link" } },

        "tags": { "$ref": "#/$defs/TagSet" },
        "notes": { "type": "string" }
      }
    },

    "Opportunity": {
      "type": "object",
      "required": [
        "opportunity_id",
        "created_at",
        "updated_at",
        "owner",
        "account_id",
        "sales_stage",
        "deal_name",
        "pricing_option_selected",
        "expected_value_usd",
        "time_to_value_days_target",
        "shadow_ops_map_ref",
        "exception_library_ref",
        "definition_of_done",
        "notes"
      ],
      "properties": {
        "opportunity_id": { "$ref": "#/$defs/ID" },
        "created_at": { "$ref": "#/$defs/Timestamp" },
        "updated_at": { "$ref": "#/$defs/Timestamp" },
        "owner": { "$ref": "#/$defs/Owner" },

        "account_id": { "$ref": "#/$defs/ID" },
        "primary_lead_id": { "$ref": "#/$defs/ID" },

        "sales_stage": { "$ref": "#/$defs/SalesStage" },
        "deal_name": { "type": "string" },
        "pricing_option_selected": { "type": "string", "description": "Good/Better/Best or custom" },

        "expected_value_usd": { "type": "number", "minimum": 0 },
        "time_to_value_days_target": { "type": "integer", "minimum": 1 },

        "shadow_ops_map_ref": { "type": "string", "description": "Pointer to stored Shadow Ops Map (doc id/link)" },
        "exception_library_ref": { "type": "string", "description": "Pointer to stored Exception Library (doc id/link)" },

        "scope": {
          "type": "object",
          "properties": {
            "included": { "type": "array", "items": { "type": "string" } },
            "excluded": { "type": "array", "items": { "type": "string" } },
            "client_responsibilities": { "type": "array", "items": { "type": "string" } }
          }
        },

        "definition_of_done": { "type": "array", "items": { "type": "string" } },
        "links": { "type": "array", "items": { "$ref": "#/$defs/Link" } },
        "notes": { "type": "string" }
      }
    },

    "Project": {
      "type": "object",
      "required": [
        "project_id",
        "created_at",
        "updated_at",
        "owner",
        "account_id",
        "opportunity_id",
        "delivery_stage",
        "success_stage",
        "phase",
        "modules",
        "audit_trail",
        "notes"
      ],
      "properties": {
        "project_id": { "$ref": "#/$defs/ID" },
        "created_at": { "$ref": "#/$defs/Timestamp" },
        "updated_at": { "$ref": "#/$defs/Timestamp" },
        "owner": { "$ref": "#/$defs/Owner" },

        "account_id": { "$ref": "#/$defs/ID" },
        "opportunity_id": { "$ref": "#/$defs/ID" },

        "delivery_stage": { "$ref": "#/$defs/DeliveryStage" },
        "success_stage": { "$ref": "#/$defs/SuccessStage" },

        "phase": { "type": "string", "enum": ["PHASE_1", "PHASE_2", "PHASE_3"] },
        "modules": { "type": "array", "items": { "type": "string" } },

        "wow_workflow_id": { "$ref": "#/$defs/ID" },

        "audit_trail": { "$ref": "#/$defs/AuditTrail" },

        "baseline_kpi_snapshot_ref": { "type": "string" },
        "handoff_kit_ref": { "type": "string" },

        "notes": { "type": "string" }
      }
    },

    "Workflow": {
      "type": "object",
      "required": [
        "workflow_id",
        "created_at",
        "updated_at",
        "owner",
        "project_id",
        "workflow_name",
        "goal",
        "status",
        "tools",
        "exception_paths_top5",
        "fallback_modes",
        "audit_events_emitted",
        "kpis_affected",
        "notes"
      ],
      "properties": {
        "workflow_id": { "$ref": "#/$defs/ID" },
        "created_at": { "$ref": "#/$defs/Timestamp" },
        "updated_at": { "$ref": "#/$defs/Timestamp" },
        "owner": { "$ref": "#/$defs/Owner" },

        "project_id": { "$ref": "#/$defs/ID" },
        "workflow_name": { "type": "string" },
        "goal": { "type": "string" },
        "status": { "$ref": "#/$defs/Status" },

        "inputs": { "type": "array", "items": { "type": "string" } },
        "outputs": { "type": "array", "items": { "type": "string" } },
        "tools": { "type": "array", "items": { "type": "string" } },

        "exception_paths_top5": { "type": "array", "items": { "type": "string" }, "maxItems": 5 },
        "fallback_modes": { "type": "array", "items": { "type": "string" } },

        "audit_events_emitted": { "type": "array", "items": { "type": "string" } },
        "kpis_affected": { "type": "array", "items": { "type": "string" } },

        "notes": { "type": "string" }
      }
    },

    "Deliverable": {
      "type": "object",
      "required": [
        "deliverable_id",
        "created_at",
        "updated_at",
        "owner",
        "project_id",
        "deliverable_type",
        "title",
        "status",
        "acceptance_criteria",
        "links",
        "notes"
      ],
      "properties": {
        "deliverable_id": { "$ref": "#/$defs/ID" },
        "created_at": { "$ref": "#/$defs/Timestamp" },
        "updated_at": { "$ref": "#/$defs/Timestamp" },
        "owner": { "$ref": "#/$defs/Owner" },

        "project_id": { "$ref": "#/$defs/ID" },

        "deliverable_type": {
          "type": "string",
          "enum": ["BUILD_PLAN", "WORKFLOW_SPEC", "AGENT_SPEC", "QA_REPORT", "HANDOFF_KIT", "DASHBOARD", "TRAINING", "SOP", "OTHER"]
        },
        "title": { "type": "string" },
        "status": { "$ref": "#/$defs/Status" },

        "acceptance_criteria": { "type": "array", "items": { "type": "string" } },
        "links": { "type": "array", "items": { "$ref": "#/$defs/Link" } },
        "notes": { "type": "string" }
      }
    },

    "KPI": {
      "type": "object",
      "required": [
        "kpi_id",
        "created_at",
        "updated_at",
        "project_id",
        "kpi_name",
        "definition",
        "baseline_value",
        "current_value",
        "target_value",
        "frequency",
        "notes"
      ],
      "properties": {
        "kpi_id": { "$ref": "#/$defs/ID" },
        "created_at": { "$ref": "#/$defs/Timestamp" },
        "updated_at": { "$ref": "#/$defs/Timestamp" },

        "project_id": { "$ref": "#/$defs/ID" },
        "kpi_name": { "type": "string" },
        "definition": { "type": "string" },

        "baseline_value": { "type": "string" },
        "current_value": { "type": "string" },
        "target_value": { "type": "string" },

        "frequency": { "type": "string", "enum": ["daily", "weekly", "monthly"] },
        "notes": { "type": "string" }
      }
    },

    "Ticket": {
      "type": "object",
      "required": [
        "ticket_id",
        "created_at",
        "updated_at",
        "owner",
        "project_id",
        "severity",
        "status",
        "title",
        "description",
        "exception_tag",
        "next_step",
        "notes"
      ],
      "properties": {
        "ticket_id": { "$ref": "#/$defs/ID" },
        "created_at": { "$ref": "#/$defs/Timestamp" },
        "updated_at": { "$ref": "#/$defs/Timestamp" },
        "owner": { "$ref": "#/$defs/Owner" },

        "project_id": { "$ref": "#/$defs/ID" },
        "workflow_id": { "$ref": "#/$defs/ID" },

        "severity": { "$ref": "#/$defs/Severity" },
        "status": { "$ref": "#/$defs/Status" },

        "title": { "type": "string" },
        "description": { "type": "string" },

        "exception_tag": { "type": "string", "description": "One of the defined exception tags for the project/workflow" },

        "next_step": { "type": "string" },
        "links": { "type": "array", "items": { "$ref": "#/$defs/Link" } },
        "notes": { "type": "string" }
      }
    },

    "ChangeRequest": {
      "type": "object",
      "required": [
        "change_request_id",
        "created_at",
        "updated_at",
        "owner",
        "project_id",
        "status",
        "request_summary",
        "reason",
        "impact_scope",
        "impact_cost",
        "impact_timeline",
        "notes"
      ],
      "properties": {
        "change_request_id": { "$ref": "#/$defs/ID" },
        "created_at": { "$ref": "#/$defs/Timestamp" },
        "updated_at": { "$ref": "#/$defs/Timestamp" },
        "owner": { "$ref": "#/$defs/Owner" },

        "project_id": { "$ref": "#/$defs/ID" },
        "ticket_id": { "$ref": "#/$defs/ID" },

        "status": { "type": "string", "enum": ["proposed", "under_review", "approved", "rejected", "implemented"] },

        "request_summary": { "type": "string" },
        "reason": { "type": "string" },

        "impact_scope": { "type": "array", "items": { "type": "string" } },
        "impact_cost": { "type": "string", "description": "e.g., +$1500 or included" },
        "impact_timeline": { "type": "string", "description": "e.g., +5 business days" },

        "approval": {
          "type": "object",
          "properties": {
            "approved_by": { "type": "string" },
            "approved_at": { "$ref": "#/$defs/Timestamp" }
          }
        },

        "notes": { "type": "string" }
      }
    },

    "ProofAsset": {
      "type": "object",
      "required": [
        "proof_asset_id",
        "created_at",
        "updated_at",
        "owner",
        "account_id",
        "project_id",
        "type",
        "status",
        "headline",
        "before_after_points",
        "shadow_ops_reduction",
        "exception_reduction",
        "auditability_improvement",
        "links",
        "notes"
      ],
      "properties": {
        "proof_asset_id": { "$ref": "#/$defs/ID" },
        "created_at": { "$ref": "#/$defs/Timestamp" },
        "updated_at": { "$ref": "#/$defs/Timestamp" },
        "owner": { "$ref": "#/$defs/Owner" },

        "account_id": { "$ref": "#/$defs/ID" },
        "project_id": { "$ref": "#/$defs/ID" },

        "type": { "type": "string", "enum": ["testimonial", "case_study", "micro_case", "screenshot", "video_clip"] },
        "status": { "type": "string", "enum": ["draft", "requested", "approved", "published"] },

        "headline": { "type": "string" },
        "before_after_points": { "type": "array", "items": { "type": "string" } },

        "shadow_ops_reduction": { "type": "array", "items": { "type": "string" } },
        "exception_reduction": { "type": "array", "items": { "type": "string" } },
        "auditability_improvement": { "type": "array", "items": { "type": "string" } },

        "links": { "type": "array", "items": { "$ref": "#/$defs/Link" } },
        "notes": { "type": "string" }
      }
    },

    "AuditEvent": {
      "type": "object",
      "required": [
        "audit_event_id",
        "created_at",
        "actor",
        "entity_type",
        "entity_id",
        "event_type",
        "event_summary",
        "result_status"
      ],
      "properties": {
        "audit_event_id": { "$ref": "#/$defs/ID" },
        "created_at": { "$ref": "#/$defs/Timestamp" },

        "actor": {
          "type": "object",
          "required": ["actor_type", "actor_id"],
          "properties": {
            "actor_type": {
              "type": "string",
              "enum": ["agent1", "agent2", "agent3", "agent4", "agent5", "agent6", "agent7", "agent8", "agent9", "agent10", "you", "client", "system"]
            },
            "actor_id": { "$ref": "#/$defs/ID" }
          }
        },

        "entity_type": {
          "type": "string",
          "enum": ["lead", "account", "opportunity", "project", "workflow", "deliverable", "kpi", "ticket", "change_request", "proof_asset"]
        },
        "entity_id": { "$ref": "#/$defs/ID" },

        "event_type": {
          "type": "string",
          "description": "Standardize your event types so auditability is measurable",
          "examples": [
            "lead.scored",
            "outreach.sent",
            "call.booked",
            "proposal.sent",
            "deal.won",
            "workflow.executed",
            "exception.triggered",
            "fallback.used",
            "ticket.created",
            "ticket.resolved",
            "change_request.approved",
            "proof_asset.published"
          ]
        },

        "event_summary": { "type": "string" },
        "result_status": { "type": "string", "enum": ["success", "partial", "failed"] },

        "exception_tag": { "type": "string" },
        "tool_used": { "type": "string" },
        "inputs_hash": { "type": "string" },
        "outputs_hash": { "type": "string" },

        "links": { "type": "array", "items": { "$ref": "#/$defs/Link" } }
      }
    }
  }
}
